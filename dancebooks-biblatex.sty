\NeedsTeXFormat{LaTeX2e}

% файл biblatex-dm.cfg необходимо писать в самом начале
\RequirePackage{filecontents}
\begin{filecontents}{biblatex-dm.cfg}
\DeclareDatamodelFields[type=list,datatype=literal]{isbn}
\DeclareDatamodelEntryfields[mvbook]{part}
\DeclareDatamodelEntryfields[periodical]{location,publisher,part}
\DeclareDatamodelConstraints{
	% обязательно должно присутствовать полу hyphenation
	\constraint[type=mandatory]{
		\constraintfield{hyphenation}
	}
	% обязательно должен присутствовать author или shorthand
	\constraint[type=mandatory]{
		\constraintfieldsor{
			\constraintfield{author}
			\constraintfield{shorthand}
		}
	}
	% если есть publisher, должен быть задан location
	\constraint[type=conditional]{
		\consequent[quantifier=all]{
			\constraintfield{location}
		}
		\antecedent[quantifier=all]{
			\constraintfield{publisher}
		}
	}
	% если есть хотя бы одно из полей {origlanguage, translator}, то должны присутствовать обы
	\constraint[type=conditional]{
		\consequent[quantifier=all]{
			\constraintfield{translator}
			\constraintfield{origlanguage}
		}
		\antecedent[quantifier=one]{
			\constraintfield{translator}
			\constraintfield{origlanguage}
		}
	}
}
\DeclareDatamodelConstraints[book,mvbook]{
	% только для книг и многотомных изданий: если задан volume, должно быть известно общее число томов volumes
	\constraint[type=conditional]{
		\consequent[quantifier=all]{
			\constraintfield{volumes}
		}
		\antecedent[quantifier=all]{
			\constraintfield{volume}
		}
	}
}
\DeclareDatamodelConstraints[thesis,phdthesis,masterthesis]{
	% для разного рода диссертаций: обязательно присутствие ссылки (все диссертации, кажется, выкладываются в интернет)
	\constraint[type=mandatory]{
		\constraintfield{url}
	}
}
\end{filecontents}

\RequirePackage[utf8]{inputenc}
\RequirePackage{csquotes}
\RequirePackage[hyphens]{url}
\RequirePackage[unicode]{hyperref}
\RequirePackage{bookmark}
\RequirePackage[T1,T2A]{fontenc}
\RequirePackage[czech,danish,english,french,german,italian,polish,portuguese,spanish,russian]{babel}
\RequirePackage[bibencoding=utf-8,style=gost-authoryear,backend=biber,babel=other,ibidtracker=false,maxitems=5]{biblatex}
\RequirePackage{xpatch}

\RequirePackage{kvoptions}
\SetupKeyvalOptions{family=dancebooks,prefix=dancebooks@}
\DeclareStringOption{root}
\DeclareBoolOption[false]{detailed}
\DeclareBoolOption[true]{usedefaults}
\ProcessKeyvalOptions*

\ProvidesPackage{\dancebooks@root/dancebooks-biblatex}[2013/12/31 Special package for formatting of bibliography]

% пишем слова URL и ISBN капителью
\renewcommand\mkbibacro[1]{\textsc{\MakeLowercase{#1}}}

\DeclareSourcemap{
	\maps[datatype=bibtex]{
		\map{
			\step[fieldsource=keywords]
			\step[fieldset=lista, origfieldval]
			\step[fieldsource=lista,
				match=\regexp{\s*,\s*},
				replace=\regexp{\x20and\x20}]
		}
	}
}

% переопределяем макрос cite
% в списке литературы добавляем метку в квадратных скобках
\renewbibmacro*{cite}{%
\iffieldundef{shorthand}%
{\printnames{labelname}\setunit{\nameyeardelim}\printfield{year}\printfield{extrayear}}%
{\printfield{shorthand}\setunit{\nameyeardelim}\printfield{year}\printfield{extrayear}}%
}

% добавляем поддержку поля shorthand
% форсируем его использование вместо автосгенерённого значения
\renewbibmacro*{begentry}{\brackettext{%
\iffieldundef{shorthand}%
{\printnames{labelname}\setunit{\nameyeardelim}\printfield{year}\printfield{extrayear}}%
{\printfield{shorthand}\setunit{\nameyeardelim}\printfield{year}\printfield{extrayear}}%
}\addnbspace}

% добавляем поля annotation и keywords
% только если указан флаг в параметрах
\ifdancebooks@detailed%
\xapptobibmacro{url+urldate+note}{%
\iffieldundef{annotation}%
{}%
{\newline\mkbibacro{NOTE:}\addspace\usebibmacro{annotation}}%
\iffieldundef{keywords}%
{}%
{\newline\mkbibacro{KEYWORDS}:\addspace\usebibmacro{lista}}%
}
{}{}%
\else
\fi

% макрос переформатирования для года
% убираем букву после года в библиографической записи
\DeclareFieldFormat{extrayear}{\mknumalph{#1}}
\renewbibmacro*{date}{\printdate}
\renewbibmacro*{year}{\printfield{year}}

% макрос переформатирования для поля isbn
% добавляем поддержку нескольких значений isbn, перечисленных через and
\DeclareListFormat{isbn}{%
\ifnumequal{\value{listcount}}{\value{liststart}}%
{\mkbibacro{isbn}\addcolon\addspace}%
{}%
\ifnumgreater{\value{listcount}}{\value{liststart}}%
{\addcomma\addspace}%
{\addcomma\addspace}%
#1}

%определяем формат для печати списка ISBN
\renewbibmacro*{isbn}{\printlist{isbn}}

%определяем формат для печати списка lista
%выше мы сказали, что будем использовать это поле для хранения keywords
%используем \newbibmacro* вместо \renewbibmacro*, чтобы избавиться от warning'а
\newbibmacro*{lista}{\printlist{lista}}

% добавляем пустую строчку после каждой книги
\renewbibmacro*{finentry}{\finentry\newline}

% добавляем возможность исключить источники библиографии по умолчанию
\ifdancebooks@usedefaults
	\addbibresource{\dancebooks@root/bib/!missing.bib}
	\addbibresource{\dancebooks@root/bib/!problems.bib}
	\addbibresource{\dancebooks@root/bib/american.bib}
	%\addbibresource{\dancebooks@root/bib/anuario-musical.bib}
	\addbibresource{\dancebooks@root/bib/australian.bib}
	\addbibresource{\dancebooks@root/bib/canadian.bib}
	\addbibresource{\dancebooks@root/bib/czech.bib}
	\addbibresource{\dancebooks@root/bib/danish.bib}
	\addbibresource{\dancebooks@root/bib/dutch.bib}
	\addbibresource{\dancebooks@root/bib/english.bib}
	\addbibresource{\dancebooks@root/bib/french.bib}
	\addbibresource{\dancebooks@root/bib/german.bib}
	\addbibresource{\dancebooks@root/bib/italian.bib}
	%\addbibresource{\dancebooks@root/bib/journal-of-musicology.bib}
	\addbibresource{\dancebooks@root/bib/mexican.bib}
	\addbibresource{\dancebooks@root/bib/polish.bib}
	\addbibresource{\dancebooks@root/bib/portuguese.bib}
	\addbibresource{\dancebooks@root/bib/proceedings-rothenfelser.bib}
	\addbibresource{\dancebooks@root/bib/proceedings-spb.bib}
	\addbibresource{\dancebooks@root/bib/russian.bib}
	\addbibresource{\dancebooks@root/bib/spanish.bib}
	\addbibresource{\dancebooks@root/bib/swiss.bib}
\else
\fi