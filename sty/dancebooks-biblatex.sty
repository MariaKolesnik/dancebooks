\NeedsTeXFormat{LaTeX2e}

\RequirePackage[utf8]{inputenc}
\RequirePackage{csquotes}
\RequirePackage[hyphens]{url}
\RequirePackage[unicode]{hyperref}
\RequirePackage[T2A]{fontenc}
\RequirePackage[czech,danish,english,french,german,italian,polish,portuguese,spanish,russian]{babel}
\RequirePackage[bibencoding=cp1251,style=gost-authoryear,backend=biber,babel=other,ibidtracker=false]{biblatex}
\RequirePackage{xpatch}

\RequirePackage{kvoptions}
\SetupKeyvalOptions{family=dancebooks,prefix=dancebooks@}
\DeclareStringOption{root}
\DeclareBoolOption{detailed}
\ProcessKeyvalOptions*

\ProvidesPackage{\dancebooks@root/sty/dancebooks-biblatex}[2012/12/31 Special package for formatting of BIB labels]

\DeclareFieldFormat{extrayear}{\mknumalph{#1}}

\renewbibmacro*{date}{\printdate}%
\renewbibmacro*{year}{\printfield{year}}%

\renewbibmacro*{cite}{%
\iffieldundef{shorthand}%
{\printnames{labelname}\setunit{\nameyeardelim}\printfield{year}\printfield{extrayear}}%
{\printfield{shorthand}\setunit{\nameyeardelim}\printfield{year}\printfield{extrayear}}%
}

\renewbibmacro*{begentry}{\brackettext{%
\iffieldundef{shorthand}%
{\printnames{labelname}\setunit{\nameyeardelim}\printfield{year}\printfield{extrayear}}%
{\printfield{shorthand}\setunit{\nameyeardelim}\printfield{year}\printfield{extrayear}}%
}\addnbspace}

\ifdancebooks@detailed%
\xapptobibmacro{url+urldate+note}{%
\iffieldundef{annotation}%
{}%
{\usebibmacro{annotation}}%
}{}{}%
\else
\fi

\renewbibmacro*{finentry}{\finentry\newline}

\addbibresource{\dancebooks@root/bib/american.bib}
\addbibresource{\dancebooks@root/bib/anuario-musical.bib}
\addbibresource{\dancebooks@root/bib/australian.bib}
\addbibresource{\dancebooks@root/bib/canadian.bib}
\addbibresource{\dancebooks@root/bib/czech.bib}
\addbibresource{\dancebooks@root/bib/danish.bib}
\addbibresource{\dancebooks@root/bib/dutch.bib}
\addbibresource{\dancebooks@root/bib/english.bib}
\addbibresource{\dancebooks@root/bib/french.bib}
\addbibresource{\dancebooks@root/bib/german.bib}
\addbibresource{\dancebooks@root/bib/hda.bib}
\addbibresource{\dancebooks@root/bib/italian.bib}
%\addbibresource{\dancebooks@root/bib/journal-of-musicology.bib}
\addbibresource{\dancebooks@root/bib/polish.bib}
\addbibresource{\dancebooks@root/bib/portuguese.bib}
\addbibresource{\dancebooks@root/bib/problems.bib}
\addbibresource{\dancebooks@root/bib/proceedings-rothenfelser.bib}
\addbibresource{\dancebooks@root/bib/proceedings-spb.bib}
\addbibresource{\dancebooks@root/bib/russian.bib}
\addbibresource{\dancebooks@root/bib/spanish.bib}